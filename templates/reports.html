<!DOCTYPE html>
<html lang="it" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elenco Esecuzioni Report</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body { padding: 20px; }
        .container { max-width: 900px; }
        .list-group-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .report-info { flex-grow: 1; margin-right: 15px; } /* DÃ  spazio a destra */
        .report-name {
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.1rem;
            font-weight: bold;
        }
        .report-actions button { margin-left: 5px; } /* Spazio tra i pulsanti */
    </style>
</head>
<body>

    <div class="container">

        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="mb-0">ðŸ“Š Elenco Esecuzioni Report</h2>
            <a href="/" class="btn btn-outline-primary">
                <i class="bi bi-pencil-square"></i> Torna all'Editor
            </a>
        </div>

        <p class="text-body-secondary">
            Elenco di tutti i report di esecuzione trovati nella cartella
            <code>reports/unified</code>, ordinati dal piÃ¹ recente.
        </p>

        <ul class="list-group" id="report-list">
            <li class="list-group-item text-center p-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2">Scansione report in corso...</p>
            </li>
        </ul>
    </div>

    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="delete-toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto" id="toast-title">Notifica</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toast-body">
                Report eliminato con successo!
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const reportList = document.getElementById('report-list');
        const toastElement = document.getElementById('delete-toast');
        const bsToast = new bootstrap.Toast(toastElement);

        document.addEventListener('DOMContentLoaded', loadReportList);

        async function loadReportList() {
            reportList.innerHTML = `
                <li class="list-group-item text-center p-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">Scansione report in corso...</p>
                </li>`;
            try {
                const response = await fetch('/api/reports');
                const reports = await response.json();

                reportList.innerHTML = ''; // Pulisce il placeholder

                if (reports.length === 0) {
                    reportList.innerHTML = `
                        <li class="list-group-item text-center p-4">
                            <h5 class="text-warning">Nessun report trovato.</h5>
                            <p class="mb-0">Esegui <code>python main_runner.py</code> per generare un report.</p>
                        </li>
                    `;
                    return;
                }

                reports.forEach(report => {
                    const li = document.createElement('li');
                    li.className = "list-group-item";
                    li.id = `report-item-${report.name}`; // ID univoco per l'elemento

                    const formattedName = formatTimestampName(report.name);

                    li.innerHTML = `
                        <div class="report-info">
                            <a href="/reports/view/${report.path}" target="_blank" class="text-decoration-none">
                                <span class="report-name">${report.name}</span>
                            </a>
                            <br>
                            <small class="text-body-secondary">${formattedName}</small>
                        </div>
                        <div class="report-actions">
                             <a href="/reports/view/${report.path}" target="_blank" class="btn btn-sm btn-outline-primary" title="Apri Report">
                                <i class="bi bi-box-arrow-up-right"></i> Apri
                            </a>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteReport('${report.name}')" title="Elimina Report">
                                <i class="bi bi-trash"></i> Elimina
                            </button>
                        </div>
                    `;
                    reportList.appendChild(li);
                });

            } catch (error) {
                console.error("Errore nel caricamento dei report:", error);
                reportList.innerHTML = `
                    <li class="list-group-item text-center p-4 text-danger">
                        Impossibile caricare l'elenco dei report: ${error.message}
                    </li>
                `;
            }
        }

        function formatTimestampName(name) {
            try {
                const parts = name.split('_');
                const datePart = parts[0];
                const timePart = parts[1];
                const year = datePart.substring(0, 4);
                const month = datePart.substring(4, 6);
                const day = datePart.substring(6, 8);
                const hour = timePart.substring(0, 2);
                const minute = timePart.substring(2, 4);
                const second = timePart.substring(4, 6);
                const date = new Date(year, month - 1, day, hour, minute, second);
                return date.toLocaleString('it-IT', { dateStyle: 'full', timeStyle: 'medium' });
            } catch (e) {
                return "Data non valida";
            }
        }

        // --- FUNZIONE PER ELIMINARE ---
        async function deleteReport(folderName) {
            if (!confirm(`Sei sicuro di voler eliminare definitivamente il report "${folderName}" e tutti i suoi contenuti?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/reports/${folderName}`, {
                    method: 'DELETE',
                });

                const result = await response.json();

                if (!response.ok || result.error) {
                    throw new Error(result.error || `Errore server: ${response.statusText}`);
                }

                // Rimuovi l'elemento dalla lista
                const itemToRemove = document.getElementById(`report-item-${folderName}`);
                if (itemToRemove) {
                    itemToRemove.remove();
                }

                showToast("Eliminazione", result.message || "Report eliminato con successo.", "success");

                // Se la lista Ã¨ vuota, mostra il messaggio appropriato
                if (reportList.children.length === 0) {
                     reportList.innerHTML = `
                        <li class="list-group-item text-center p-4">
                            <h5 class="text-warning">Nessun report rimasto.</h5>
                        </li>
                    `;
                }

            } catch (error) {
                console.error(`Errore eliminazione report ${folderName}:`, error);
                showToast("Errore Eliminazione", `Impossibile eliminare il report: ${error.message}`, "danger");
            }
        }

        // --- Utility Notifica (Toast) ---
        function showToast(title, body, type = 'success') {
            const toastTitle = document.getElementById('toast-title');
            const toastBody = document.getElementById('toast-body');

            toastTitle.textContent = title;
            toastBody.textContent = body;

            toastElement.classList.remove('text-bg-success', 'text-bg-danger');
            if (type === 'success') {
                toastElement.classList.add('text-bg-success');
            } else if (type === 'danger') {
                toastElement.classList.add('text-bg-danger');
            }
            bsToast.show();
        }
    </script>
</body>
</html>